name: CI

on:
  pull_request:
    branches: [ dev ]

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    # ===============================================
    # ğŸ’¡ 1. MySQL Docker ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ ì •ì˜ (í•„ìˆ˜)
    # ===============================================
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root  # ì»¨í…Œì´ë„ˆ ì‹œì‘ì— í•„ìš”í•œ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸
          MYSQL_DATABASE: test_db    # í…ŒìŠ¤íŠ¸ DB ì´ë¦„
        ports:
          - 3306:3306                # í˜¸ìŠ¤íŠ¸ í¬íŠ¸ë¡œ ì—°ê²°
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping || exit 1"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 20

    env:
      SPRING_PROFILES_ACTIVE: test
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle # Gradle ì„¤ì •, ì¢…ì†ì„± ë° ë¹Œë“œ ìºì‹œë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      # ğŸ’¡ 2ë‹¨ê³„: Spring Boot ì ‘ì† ì •ë³´ ì„¤ì •
      - name: Configure DB Connection & Redis Connection
        run: |
          # 127.0.0.1:3306ìœ¼ë¡œ ì ‘ì†í•˜ë„ë¡ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          echo "SPRING_DATASOURCE_URL=jdbc:mysql://127.0.0.1:3306/test_db?useSSL=false&allowPublicKeyRetrieval=true" >> $GITHUB_ENV
          echo "SPRING_DATASOURCE_USERNAME=root" >> $GITHUB_ENV
          echo "SPRING_DATASOURCE_PASSWORD=root" >> $GITHUB_ENV
          
          echo "SPRING_DATA_REDIS_HOST=127.0.0.1" >> $GITHUB_ENV
          echo "SPRING_DATA_REDIS_PORT=6379" >> $GITHUB_ENV
          echo "SPRING_DATA_REDIS_PASSWORD=" >> $GITHUB_ENV

      - name: Grant execute permission for Gradlew
        run: chmod +x gradlew

      - name: Export environment variables
        run: |
          echo "TOSS_SECRET_KEY=${{ secrets.TOSS_SECRET_KEY }}" >> $GITHUB_ENV

      # checkë¥¼ í†µí•´ì„œ ë¹Œë“œì™€ í…ŒìŠ¤íŠ¸ ë™ì‹œì— ì§„í–‰ / test ì„¤ì •ì„ CIì— ì‚¬ìš©
      - name: Run tests with coverage check
        run: ./gradlew clean check